#!/usr/bin/env sh 

export LD_LIBRARY_PATH=<%= node['mysql']['base_dir'] %>/lib/

<%= node['mysql']['base_dir'] %>/bin/rdrs -config=<%= node['ndb']['root_dir'] %>/rdrs_config.json  2>&1 > /dev/null &

pid=$!
echo $pid > <%= node['ndb']['log_dir'] %>/rdrs.pid

# wait for the server to connect to RonDB
for n in `seq 1 60`
do
  sleep 1
  wget -qO-  <%= node['ndb']['rdrs']['bind_ip'] %>:<%= node['ndb']['rdrs']['bind_port'] %>/<%= node['ndb']['rdrs']['version'] %>/stat 2>&1 > /dev/null &
  ret=$?

  if [ "$ret" -eq "0" ]; then
   exit 0;
  fi
done

exit 1
